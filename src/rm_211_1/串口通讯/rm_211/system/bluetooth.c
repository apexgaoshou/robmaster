#include "stm32f10x.h"                  // Device header
#include <stdio.h>
#include <stdarg.h>

uint8_t Serial_TxPacket[4];				//???³²??????????ï…??????????FF 01 02 03 04 FE
uint8_t Serial_RxPacket[4];				//????????????????
uint8_t Serial_RxFlag;					//???????????????¦Ë

/**
  * ??    ????????????
  * ??    ??????
  * ?? ?? ?????
  */
void Serial_Init(void)
{
	/*???????*/
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1, ENABLE);	//????USART1?????
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);	//????GPIOA?????
	
	/*GPIO?????*/
	GPIO_InitTypeDef GPIO_InitStructure;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOA, &GPIO_InitStructure);					//??PA9????????????????????
	
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOA, &GPIO_InitStructure);					//??PA10?????????????????
	
	/*USART?????*/
	USART_InitTypeDef USART_InitStructure;					//??????????
	USART_InitStructure.USART_BaudRate =9600;				//??????
	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;	//???????????????
	USART_InitStructure.USART_Mode = USART_Mode_Tx | USART_Mode_Rx;	//??????????????????????
	USART_InitStructure.USART_Parity = USART_Parity_No;		//???§µ?ï…?????
	USART_InitStructure.USART_StopBits = USART_StopBits_1;	//??¦Ë?????1¦Ë
	USART_InitStructure.USART_WordLength = USART_WordLength_8b;		//????????8¦Ë
	USART_Init(USART1, &USART_InitStructure);				//?????????????USART_Init??????USART1
	
	/*?§Ø????????*/
	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);			//?????????????????§Ø?
	
	/*NVIC?§Ø????*/
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);			//????NVIC?????2
	
	/*NVIC????*/
	NVIC_InitTypeDef NVIC_InitStructure;					//??????????
	NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;		//???????NVIC??USART1??
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;			//???NVIC??¡¤???
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;		//???NVIC??¡¤???????????1
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;		//???NVIC??¡¤???????????1
	NVIC_Init(&NVIC_InitStructure);							//?????????????NVIC_Init??????NVIC????
	
	/*USART???*/
	USART_Cmd(USART1, ENABLE);								//???USART1????????????
}

/**
  * ??    ?????????????????
  * ??    ????Byte ????????????
  * ?? ?? ?????
  */
void Serial_SendByte(uint8_t Byte)
{
	USART_SendData(USART1, Byte);		//?????????§Õ????????????§Õ???USART????????????
	while (USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET);	//??????????
	/*???§Õ???????????????????????????¦Ë????????????????????¦Ë*/
}

/**
  * ??    ??????????????????
  * ??    ????Array ??????????????
  * ??    ????Length ?????????????
  * ?? ?? ?????
  */
void Serial_SendArray(uint8_t *Array, uint16_t Length)
{
	uint16_t i;
	for (i = 0; i < Length; i ++)		//????????
	{
		Serial_SendByte(Array[i]);		//???¦Å???Serial_SendByte??????????????
	}
}

/**
  * ??    ???????????????????
  * ??    ????String ????????????????
  * ?? ?? ?????
  */
void Serial_SendString(char *String)
{
	uint8_t i;
	for (i = 0; String[i] != '\0'; i ++)//??????????÷Ï?????????????????????????¦Ë????
	{
		Serial_SendByte(String[i]);		//???¦Å???Serial_SendByte??????????????
	}
}

/**
  * ??    ?????¦Ç??????????????
  * ?? ?? ????????????X??Y?¦Ç?
  */
uint32_t Serial_Pow(uint32_t X, uint32_t Y)
{
	uint32_t Result = 1;	//??????????1
	while (Y --)			//???Y??
	{
		Result *= X;		//??X???????
	}
	return Result;
}

/**
  * ??    ???????????????
  * ??    ????Number ?????????????¦¶??0~4294967295
  * ??    ????Length ????????????????¦¶??0~10
  * ?? ?? ?????
  */
void Serial_SendNumber(uint32_t Number, uint8_t Length)
{
	uint8_t i;
	for (i = 0; i < Length; i ++)		//?????????????????????¦Ë
	{
		Serial_SendByte(Number / Serial_Pow(10, Length - i - 1) % 10 + '0');	//???¦Å???Serial_SendByte?????¦Ë????
	}
}

/**
  * ??    ???????printf?????????????
  * ??    ???????????????????????
  * ?? ?? ??????????????????????
  */
int fputc(int ch, FILE *f)
{
	Serial_SendByte(ch);			//??printf???????????????????????
	return ch;
}

/**
  * ??    ????????????prinf????
  * ??    ????format ??????????
  * ??    ????... ????????§Ò?
  * ?? ?? ?????
  */
void Serial_Printf(char *format, ...)
{
	char String[100];				//???????????
	va_list arg;					//??????????§Ò?????????????arg
	va_start(arg, format);			//??format?????????????§Ò???arg????
	vsprintf(String, format, arg);	//???vsprintf???????????????????§Ò????????????
	va_end(arg);					//????????arg
	Serial_SendString(String);		//?????????????÷Ï???????
}

/**
  * ??    ????????????????
  * ??    ??????
  * ?? ?? ?????
  * ?    ??????????????Serial_TxPacket??????????????????FF????¦Â??FE??????????????????
  */
void Serial_SendPacket(void)
{
	Serial_SendByte(0xFF);
	Serial_SendArray(Serial_TxPacket, 4);
	Serial_SendByte(0xFE);
}

/**
  * ??    ??????????????????????¦Ë
  * ??    ??????
  * ?? ?? ??????????????????¦Ë????¦¶??0~1????????????????¦Ë??1?????????¦Ë???????
  */
uint8_t Serial_GetRxFlag(void)
{
	if (Serial_RxFlag == 1)			//??????¦Ë?1
	{
		Serial_RxFlag = 0;
		return 1;					//???1?????????????¦Ë
	}
	return 0;						//??????¦Ë?0?????0
}

/**
  * ??    ????USART1?§Ø????
  * ??    ??????
  * ?? ?? ?????
  * ??????????????§Ø???????????????§Ø????????????
  *           ????????????????????????????????????
  *           ???????????????????????¦Ê¦Â????????§Ø?????????????
  */
void USART1_IRQHandler(void)
{
	static uint8_t RxState = 0;		//???????????????????????
	static uint8_t pRxPacket = 0;	//?????????????????¦Ë?????????
	if (USART_GetITStatus(USART1, USART_IT_RXNE) == SET)		//?§Ø??????USART1???????????????§Ø?
	{
		uint8_t RxData = USART_ReceiveData(USART1);				//?????????????????????????????
		
		/*??????????¡¤?????¦Ä????????????????*/
		
		/*??????0??????????????*/
		if (RxState == 0)
		{
			if (RxData == 0xFF)			//?????????????
			{
				RxState = 1;			//?????????
				pRxPacket = 0;			//???????¦Ë?¨´???
			}
		}
		/*??????1???????????????*/
		else if (RxState == 1)
		{
			Serial_RxPacket[pRxPacket] = RxData;	//??????????????????????¦Ë??
			pRxPacket ++;				//???????¦Ë??????
			if (pRxPacket >= 4)			//??????4??????
			{
				RxState = 2;			//?????????
			}
		}
		/*??????2?????????????¦Â*/
		else if (RxState == 2)
		{
			if (RxData == 0xFE)			//????????????¦Â??
			{
				RxState = 0;			//????0
				Serial_RxFlag = 1;		//????????????¦Ë??1?????????????????
			}
		}
		
		USART_ClearITPendingBit(USART1, USART_IT_RXNE);		//??????¦Ë
	}
}